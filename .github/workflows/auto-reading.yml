name: Auto Reading Bot

on:
  # 定时触发 - 每天早上8点和晚上8点执行
  schedule:
    #-     #- cron: '0 0 * *# UTC 00:00 = 北京时间 08:00
    -     #- cron: '0 12 * # UTC 12:00 = 北京时间 20:00
    #-     #- cron: '0 4 * # UTC 4:00 = 北京时间 12:00
  
  # 拉取请求触发，用于测试阅读
  pull_request:
    branches: [ main ]
    paths:
      - 'weread-bot.py'
      - 'requirements.txt'
      - '.github/workflows/ci.yml'

  # 手动触发
  workflow_dispatch:
    inputs:
      target_duration:
        description: '阅读时长（分钟，格式：10-20。建议：频繁运行时设置5-10分钟，GitHub免费版每月2000分钟额度）'
        required: false
        default: '1-2'
        type: string
      reading_mode:
        description: '阅读模式'
        required: false
        default: 'smart_random'
        type: choice
        options:
        - smart_random
        - sequential
        - pure_random
      notify_enabled:
        description: '启用通知'
        required: false
        default: true
        type: boolean

jobs:
  auto-reading:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2小时超时
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Create config file
      run: |
        cat > config.yaml << 'EOF'
        app:
          name: "WeReadBot-GitHub-Action"
          startup_mode: "immediate"
          startup_delay: "1-2"

        reading:
          mode: "${{ github.event.inputs.reading_mode || 'smart_random' }}"
          # 目标阅读时长（分钟），支持区间随机，格式如："1" 或 "1-2"，当前为：1分钟
          target_duration: "${{ github.event.inputs.target_duration || '1' }}"
          reading_interval: "30-48"
          use_curl_data_first: true
          fallback_to_config: true
          smart_random:
            book_continuity: 0.8
            chapter_continuity: 0.7
            book_switch_cooldown: 3600

        human_simulation:
          enabled: false
          reading_speed_variation: true
          break_probability: 0.15
          break_duration: "10-20"
          rotate_user_agent: false

        network:
          timeout: 30
          retry_times: 3
          retry_delay: "5-15"
          rate_limit: 10

        notification:
          enabled: ${{ github.event.inputs.notify_enabled || true }}
          include_statistics: true

        logging:
          level: "INFO"
          format: "detailed"
          file: "logs/weread.log"
          max_size: "10MB"
          backup_count: 5
          console: true
        EOF

    - name: Create logs directory
      run: mkdir -p logs

    - name: Run WeRead Bot
      env:
        # Cookie刷新QL属性，根据不同用户的环境，可能需要设置为True或False来确保cookie刷新正常工作，默认值为false
        HACK_COOKIE_REFRESH_QL: ${{ secrets.HACK_COOKIE_REFRESH_QL }}
        # 多用户 cURL：在 WEREAD_CURL_STRING 中放置多段 curl，段与段之间至少插入两个空行
        WEREAD_CURL_STRING: ${{ secrets.WEREAD_CURL_STRING }}
        # 多用户并发控制，未设置默认 1（顺序执行）
        MAX_CONCURRENT_USERS: ${{ secrets.MAX_CONCURRENT_USERS || 1 }}
        # 通知相关环境变量
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
        APPRISE_URL: ${{ secrets.APPRISE_URL }}
        BARK_SERVER: ${{ secrets.BARK_SERVER }}
        BARK_DEVICE_KEY: ${{ secrets.BARK_DEVICE_KEY }}
        BARK_SOUND: ${{ secrets.BARK_SOUND }}
        NTFY_SERVER: ${{ secrets.NTFY_SERVER }}
        NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
        FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        FEISHU_MSG_TYPE: ${{ secrets.FEISHU_MSG_TYPE }}
        WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
        WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
        DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
        DINGTALK_MSG_TYPE: ${{ secrets.DINGTALK_MSG_TYPE }}
        GOTIFY_SERVER: ${{ secrets.GOTIFY_SERVER }}
        GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        GOTIFY_PRIORITY: ${{ secrets.GOTIFY_PRIORITY }}
        GOTIFY_TITLE: ${{ secrets.GOTIFY_TITLE }}
        # 代理设置（可选）
        HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
        HTTPS_PROXY: ${{ secrets.HTTPS_PROXY }}
        SERVERCHAN3_UID: ${{ secrets.SERVERCHAN3_UID }}
        SERVERCHAN3_SENDKEY: ${{ secrets.SERVERCHAN3_SENDKEY }}
        SERVERCHAN3_TAGS: ${{ secrets.SERVERCHAN3_TAGS }}
        SERVERCHAN3_SHORT: ${{ secrets.SERVERCHAN3_SHORT }}
        PUSHDEER_PUSHKEY: ${{ secrets.PUSHDEER_PUSHKEY }}
        PUSHDEER_TYPE: ${{ secrets.PUSHDEER_TYPE }}
        # 其他环境变量
        TZ: 'Asia/Shanghai'
      run: |
        echo "开始自动阅读任务..."
        echo "当前时间: $(date)"
        echo "运行参数:"
        echo "- 阅读时长: ${{ github.event.inputs.target_duration || '45-90' }}"
        echo "- 阅读模式: ${{ github.event.inputs.reading_mode || 'smart_random' }}"
        echo "- 启用通知: ${{ github.event.inputs.notify_enabled || true }}"
        echo "================================"
        
        # 运行阅读机器人
        python weread-bot.py --config config.yaml
